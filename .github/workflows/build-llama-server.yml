name: Build llama-server (macOS arm64 static)

on:
  push:
    tags:
      - "release-arm64-*"
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14
    env:
      BUILD_DIR: build
      BIN_NAME: llama-server
      ARCH: arm64
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build static llama-server
        run: |
          set -euo pipefail
          cmake -S . -B "$BUILD_DIR" \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES="${ARCH}" \
            -DBUILD_SHARED_LIBS=OFF \
            -DLLAMA_BUILD_TESTS=OFF \
            -DLLAMA_BUILD_EXAMPLES=ON \
            -DLLAMA_BUILD_SERVER=ON \
            -DGGML_METAL=ON \
            -DGGML_METAL_EMBED_LIBRARY=ON \
            -DGGML_ACCELERATE=ON \
            -DLLAMA_NATIVE=OFF \
            -DGGML_NATIVE=OFF
          cmake --build "$BUILD_DIR" --target "$BIN_NAME" --config Release

      - name: Package artifacts
        id: package
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME:-manual}"
          BIN_PATH="${BUILD_DIR}/bin/${BIN_NAME}"
          ARTIFACT_DIR="dist"
          ARTIFACT_NAME="llama-server-macos-arm64-static.tar.gz"

          mkdir -p "$ARTIFACT_DIR"
          cp "$BIN_PATH" "$ARTIFACT_DIR/"
          pushd "$ARTIFACT_DIR" >/dev/null
          shasum -a 256 "$BIN_NAME" > "${BIN_NAME}.sha256"
          VERSION_JSON="metadata.json"
          cat > "$VERSION_JSON" <<'EOF'
          {
            "arch": "arm64",
            "os": "macos",
            "build_type": "Release",
            "static": true,
            "metal": true,
            "metal_embed": true,
            "accelerate": true
          }
          EOF
          # include tag and upstream commit for traceability
          /usr/bin/python3 - <<'PY'
          import json, os, subprocess, datetime
          meta_path = os.path.join("metadata.json")
          with open(meta_path) as f:
              data = json.load(f)
          data["tag"] = os.environ.get("GITHUB_REF_NAME", "manual")
          data["commit"] = subprocess.check_output(["git", "rev-parse", "HEAD"]).decode().strip()
          data["created_at"] = datetime.datetime.utcnow().isoformat() + "Z"
          with open(meta_path, "w") as f:
              json.dump(data, f, indent=2)
          PY
          tar -czf "$ARTIFACT_NAME" "$BIN_NAME" "$(basename "$VERSION_JSON")"
          popd >/dev/null
          echo "artifact_path=${ARTIFACT_DIR}/${ARTIFACT_NAME}" >> "$GITHUB_OUTPUT"
          echo "sha_path=${ARTIFACT_DIR}/${BIN_NAME}.sha256" >> "$GITHUB_OUTPUT"
          echo "meta_path=${VERSION_JSON}" >> "$GITHUB_OUTPUT"

      - name: Create or update release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME:-manual}"
          ARTIFACT="${{ steps.package.outputs.artifact_path }}"
          SHA_FILE="${{ steps.package.outputs.sha_path }}"
          META_FILE="${{ steps.package.outputs.meta_path }}"

          gh release view "$TAG" >/dev/null 2>&1 || gh release create "$TAG" --title "$TAG" --notes "Automated build for $TAG"
          gh release upload "$TAG" "$ARTIFACT" "$SHA_FILE" "$META_FILE" --clobber
